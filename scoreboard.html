<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scoreboard</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: url('../images/scoreboard_background.png') no-repeat center center fixed; /* Image de fond */
            background-size: cover; /* Couvre toute la page */
            font-family: 'Press Start 2P', cursive;
            color: white;
            overflow: hidden;
            cursor: url('../images/custom-cursor.png'), pointer;
        }

        canvas {
        display: block;
        width: 100vw;
        height: 100vh;
        cursor: url('../images/custom-cursor.png'), pointer;
        }
    
        .scoreboard {
            background: rgba(0, 0, 0, 0.7); /* Fond semi-transparent */
            padding: 20px;
            border-radius: 15px;
            color: white;
            width: 80%;
            text-align: center;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); /* Effet lumineux */
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
    
        .scoreboard h2 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); /* Effet néon */
        }
    
        .scoreboard table {
            width: 100%;
            border-spacing: 10px;
            color: white;
            font-size: 18px;
        }
    
        .scoreboard th, .scoreboard td {
            padding: 12px;
            text-align: center;
        }
    
        .scoreboard img {
            border-radius: 50%; /* Style arrondi */
            width: 60px;
            height: 60px;
            object-fit: cover;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8); /* Lueur sur les images */
        }
    
        .centered-button {
            display: block;
            margin: 20px auto;
            background: linear-gradient(90deg, rgba(255, 0, 150, 0.8), rgba(0, 153, 255, 0.8));
            border: none;
            color: white;
            font-size: 18px;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 0, 150, 0.8);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Style global des boutons */
    .game-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 18px;
        text-align: center;
        color: white;
        background: linear-gradient(90deg, rgba(255, 0, 150, 0.8), rgba(0, 153, 255, 0.8));
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(255, 0, 150, 0.8);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: url('../images/custom-cursor.png'), pointer;
    }

    /* Effet au survol des boutons */
    .game-button:hover {
        transform: scale(1.1);
        box-shadow: 0 0 25px rgba(255, 255, 255, 1);
    }

    /* Masquer un bouton sans altérer son style */
    .hidden {
        visibility: hidden;
    }
    
        .centered-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255, 255, 255, 1);
        }
    
        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.6);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            transition: background-color 0.3s;
        }
    
        .drop-zone:hover {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
    
        .blinking-cursor {
            display: inline-block;
            width: 10px;
            height: 30px;
            background-color: white;
            animation: blink 0.5s step-end infinite;
        }
    
        @keyframes blink {
            from, to {
                background-color: transparent;
            }
            50% {
                background-color: white;
            }
        }
    </style>    
</head>
<body>

    <div class="scoreboard">
        <h2>Top Scores</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Profile</th>
                    <th>Name</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody">
                <!-- Scores affichés dynamiquement -->
            </tbody>
    
            <tfoot id="nameInputRow">
                <tr>
                    <td>#</td>
                    <td>
                        <div id="dropZone" class="drop-zone">
                            Drop Image Here
                        </div>
                    </td>
                    <td id="playerNameInput">
                        <span id="nameLetters"></span>
                        <span class="blinking-cursor"></span>
                    </td>
                    <td id="playerScore">0</td>
                </tr>
            </tfoot>
        </table>
    
        <!-- Bouton pour valider la saisie -->
<button class="game-button submit-button" onclick="submitPlayerScore()">Submit</button>

<!-- Retour au menu principal -->
<button class="game-button back-button" onclick="returnToHome()">Return to Home</button>
    </div>    

<script>
    let profileImage = null;
    let scoreSubmitted = false;
    let enteredName = "";
    const maxNameLength = 3;

    // Vérifier si le scoreboard est ouvert depuis le menu
    function isFromMenu() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("fromMenu") === "true";
    }

    // Masquer les champs de saisie si le scoreboard est ouvert depuis le menu
    function checkAccessFromMenu() {
    if (isFromMenu()) {
        // Masquer le bouton "Submit"
        const submitButton = document.querySelector(".submit-button");
        if (submitButton) {
            submitButton.style.display = "none"; // Supprime visuellement le bouton
        }

        // Masquer la ligne avec le #
        const nameInputRow = document.getElementById("nameInputRow");
        if (nameInputRow) {
            nameInputRow.style.visibility = "hidden"; // Masque visuellement la ligne tout en conservant l'espace
        }

        // Centrer le bouton "Return to Home"
        const backButton = document.querySelector(".back-button");
        if (backButton) {
            backButton.classList.add("centered-button");
        }

        console.log("Accès depuis le menu : ligne avec # masquée.");
    } else {
        // Afficher la ligne avec le #
        const nameInputRow = document.getElementById("nameInputRow");
        if (nameInputRow) {
            nameInputRow.style.visibility = "visible"; // Réaffiche visuellement la ligne
        }

        // Rendre le bouton Submit visible
        const submitButton = document.querySelector(".submit-button");
        if (submitButton) {
            submitButton.style.display = "block";
        }

        const backButton = document.querySelector(".back-button");
        if (backButton) {
            backButton.classList.remove("centered-button");
        }
    }
}

    // Sauvegarde automatique du score uniquement après un Game Over
    window.addEventListener("beforeunload", (event) => {
    const highScores = JSON.parse(localStorage.getItem("highScores")) || [];
    const score = localStorage.getItem("playerScore") || 0;

    // Ne sauvegarde "NPC" que si aucun score avec ce score spécifique n'existe déjà
    const scoreExists = highScores.some((entry) => entry.score === parseInt(score));

    if (!isFromMenu() && !scoreSubmitted && !scoreExists) {
        saveHighScore("NPC", score, profileImage);
        console.log("Score sauvegardé automatiquement avec 'NPC'.");
    }
});

    // Sauvegarder un score dans le localStorage
    function saveHighScore(name, score, profileImage) {
    const highScores = JSON.parse(localStorage.getItem("highScores")) || [];
    const profilePicture = profileImage || '../images/default_pp.png';

    // Ajouter le nouveau score
    highScores.push({ name, score, profileImage: profilePicture });

    // Trier par score décroissant
    highScores.sort((a, b) => b.score - a.score);

    // Limiter à 5 scores maximum
    highScores.splice(5);

    // Sauvegarder dans localStorage
    localStorage.setItem("highScores", JSON.stringify(highScores));
}

    // Afficher les scores dans le tableau
    function displayHighScores() {
    const highScores = JSON.parse(localStorage.getItem("highScores")) || [];
    const scoreTableBody = document.getElementById("scoreTableBody");

    // Remplir les scores enregistrés
    const rows = highScores.map((score, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>
                <img src="${score.profileImage || '../images/default_pp.png'}" 
                     alt="Profile" width="60" height="60">
            </td>
            <td>${score.name}</td>
            <td>${score.score}</td>
        </tr>
    `);

    // Compléter jusqu'à 5 rangs avec des placeholders
    for (let i = highScores.length; i < 5; i++) {
        rows.push(`
            <tr>
                <td>${i + 1}</td>
                <td>
                    <img src="../images/default_pp.png" alt="Profile" width="60" height="60">
                </td>
                <td>---</td>
                <td>---</td>
            </tr>
        `);
    }

    // Mettre à jour le tableau
    scoreTableBody.innerHTML = rows.join("");
}

    // Gestion du drag-and-drop pour l'image de profil
    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", (e) => e.preventDefault());
    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = () => {
                profileImage = reader.result;
                dropZone.innerHTML = `<img src="${profileImage}" alt="Profile" width="50" height="50">`;
            };
            reader.readAsDataURL(file);
        } else {
            alert("Please drop a valid image file.");
        }
    });

    // Mise à jour de la saisie du nom
    function updateNameInput() {
    const nameLetters = document.getElementById("nameLetters");
    nameLetters.textContent = enteredName;
}

    // Gérer la saisie des touches pour le nom
    window.addEventListener("keydown", (event) => {
    if (enteredName.length < maxNameLength && /^[A-Za-z]$/.test(event.key)) {
        enteredName += event.key.toUpperCase();
        updateNameInput();
    } else if (event.key === "Backspace") {
        enteredName = enteredName.slice(0, -1);
        updateNameInput();
    } else if (enteredName.length === maxNameLength && event.key === "Enter") {
        const score = parseInt(localStorage.getItem("playerScore") || "0", 10);
        const profilePicture = profileImage || '../images/default_pp.png';

        saveHighScore(enteredName, score, profilePicture); // Sauvegarde avec le nom
        localStorage.setItem("scoreSubmitted", "true");
        scoreSubmitted = true;

        document.getElementById("nameInputRow").classList.add("hidden");
        displayHighScores();
    }
});

    // Redirection vers la page principale
    function returnToHome() {
        window.location.href = "game.html";
    }

    function submitPlayerScore() {
    if (enteredName.length === maxNameLength) {
        const score = parseInt(localStorage.getItem("playerScore") || "0", 10);
        const profilePicture = profileImage || '../images/default_pp.png';

        // Sauvegarde du score
        saveHighScore(enteredName, score, profilePicture);
        localStorage.setItem("scoreSubmitted", "true"); // Marque comme soumis

        scoreSubmitted = true;

        // Cache la saisie et désactive le bouton "Submit"
        document.getElementById("nameInputRow").classList.add("hidden");
        document.querySelector(".submit-button").disabled = true;

        displayHighScores(); // Rafraîchir l'affichage des scores
        console.log("Score sauvegardé avec le nom :", enteredName);
    } else {
        alert("Please enter a valid 3-letter name.");
    }
}

function updateCurrentScoreDisplay() {
    const currentScore = parseInt(localStorage.getItem("playerScore") || "0", 10);
    const playerScoreCell = document.getElementById("playerScore");

    if (playerScoreCell) {
        playerScoreCell.textContent = currentScore; // Met à jour l'affichage du score
    }
}

window.addEventListener("load", () => {
    if (localStorage.getItem("scoreSubmitted") === "true") {
        document.querySelector(".submit-button").disabled = true;
    }
});

    // Initialiser
    checkAccessFromMenu();
    displayHighScores();
    updateCurrentScoreDisplay();
    
</script>

</body>
</html>
